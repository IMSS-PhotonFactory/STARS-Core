ブロック転送コマンドとCAEN C111Cのファームウェアのバージョンの適合性について

０．はじめに
　本書は、CAMACのブロック転送コマンドを使う場合の注意事項について記載しています。
　現時点で、ブロック転送コマンドに関係するSTARSコマンドは以下のとおりです。

　CAEN C111C - BLKSS,BLKSR,BLKSA,BLKFS,BLKFR,BLKFA
　CAEN C257  - GetValue(引数なし プログラム内部でBLKFAを使用)

１．CAEN C111Cのファームウェアバージョンが古いために起こるブロック転送コマンドの不具合について
（現象）
　BLOCK転送コマンドを送ると、"%03d %06d %06d...."というフォーマットのデータが返されるはずが、
　"%03d %04d %04d...."のフォーマットが返される。

２．ブロック転送コマンドで不具合が起きるかどうかを確認する方法
 (始）
　$telnet 192.168.0.98 2000 <= CAEN C111Cにポート2000で接続する。
　ver <='ver'と入力　バージョンデータが返される。１番目が現在、２番目が工場出荷時
　0 02.05 - Sep 21 2005 02.03 - 30.12.2003
　jn_fwver <='jn_fwver'と入力　現在のファームウェアのバージョン
　0 02.05 - Sep 21 2005
　jn_fpgaver <='jn_fpgaver'と入力　工場出荷時のファームウェアのバージョン
　0 02.03 - 30.12.2003
　BLKFA 0 10 16 <='BLKFA 0 10 16'と入力、10はCAEN C257のスロット番号です。
　0
　008 0080 0000 0000 0055 005D 007F 00FF 00FF 0000 0000 0000 0000 0000 0000 
　0000 0
　000 0000 0000 0000 0055 005D 007F 00FF 00FF 0000 0000 0000 0000 0000 0000 
　0000 0
　00000
　(終）
-------------------------------------------------------------------------------
　BLKFAコマンドで返されるデータフォーマットは"%03d %06d %06d....”が正しい。
　例えば以下のように・・・

　BLKFA 0 10 16 <='BLKFA 0 10 16'と入力、10はCAEN C257のスロット番号です。
　0
　224 000000 000000 000000 000000 000000 000000 000000 000000 000000 000000 
　000000
　000 0000E0 000000 000000 000000 000000 000000 000000 000000 000000 000000 
　000000
　0000000 000000 000000 000000 000000
　(終）
　
　もし BLOCK転送コマンドの戻りデータが不正な場合は、CAEN C111Cのファームウェアをバージョンアップ
　する必要があります。

３．CAENの最新ファームウェア情報
　下記のファームウェアバージョンでブロック転送コマンドの不具合は解消されています。

（Web 2007/8/1時点より）
　Firmware:C111C Firmware
　Package Release:3.09
　Size:828KB
　Issued:Jun, 2007 
　Download filename:C111C_caen_2007_03_09.zip

（CAEN C111Cの'jn_fwver'コマンドの結果より）
　jn_fwver　<= 現在のファームウェアのバージョンを返すコマンド
　0 02.08 - Feb  9 2007 <= 上記のパッチを当てた後のファームウェアのバージョン

　※Webに記載されている内容とCAEN C111Cの'jn_fwver'コマンドの内容との整合性はないようです。

４．バージョンアップ手順について補足
　詳細の手順については、CAENC111Cのマニュアル 8.Firmware Upgradeに記載されています。

■CAENC111Cのポート80でログインして、更新ファイルが置かれているNFSドライブをマウントする必要があります。
■17行目の”cd www”とある場合は、"cd app"の間違いの可能性があります。
■ファームウェアをバージョンアップするとIPアドレスがクリアされる場合があります。
　その場合はRS232C経由で再設定する必要があります。

５．バージョンアップ手順（ログ）
（ファームウェア更新前）
$telnet 192.168.0.98 2000
ver
0 02.05 - Sep 21 2005 02.03 - 30.12.2003
jn_fwver
0 02.05 - Sep 21 2005
jn_fpgaver
0 02.03 - 30.12.2003
BLKFA 0 10 16
0
008 0080 0000 0000 0055 005D 007F 00FF 00FF 0000 0000 0000 0000 0000 0000 
0000 0
000 0000 0000 0000 0055 005D 007F 00FF 00FF 0000 0000 0000 0000 0000 0000 
0000 0
00000

（ファームウェア更新処理）
$telnet 192.168.0.98
BusyBox v0.60.3 (2003.03.19-17:07+0000) Built-in shell (msh)
Enter 'help' for a list of built-in commands.

#
#
# cd app
# sh flash 192.168.0.101:/exports jenet2_caen_2007_03_09.img
Mounting network file system  192.168.0.101:/exports ...
Updating flash application partition with  jenet2_caen_2007_03_09.img ...
Processing /nfs/jenet2_caen_2007_03_09.img for /dev/mtd/4
  Copying to ram/jenet2_caen_2007_03_09.img
  File copied: 865 kB
  Verifying ram/jenet2_caen_2007_03_09.img to 
/nfs/jenet2_caen_2007_03_09.img
  File verified: OK
  Erased 865 kB @ 0 -- 100% complete.
  Copying to /dev/mtd/4
  File copied: 865 kB
  Verifying /dev/mtd/4 to ram/jenet2_caen_2007_03_09.img
  File verified: OK
Done
Unmounting network file system...
Flash succesfully completed! Please reboot!
#
# reboot

ホストとの接続が切断されました。

（ファームウェア更新後の確認）
CAMACの電源再投入
$telnet 192.168.0.98 2000
BLKFA 0 10 16
0
224 000000 000000 000000 000000 000000 000000 000000 000000 000000 000000 
000000
000 0000E0 000000 000000 000000 000000 000000 000000 000000 000000 000000 
000000
0000000 000000 000000 000000 000000
ver
0 02.08 - Feb  9 2007 02.03 - 30.12.2003
jn_fwver
0 02.08 - Feb  9 2007
jn_fpgaver
0 02.03 - 30.12.2003
（終） 
